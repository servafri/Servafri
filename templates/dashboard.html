{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
    <h1>Welcome, {{ current_user.username }}!</h1>
    <div class="dashboard-container">
        <section class="user-info">
            <h2>Your Account</h2>
            <p>Current Balance: â‚¦{{ "%.2f"|format(current_user.balance or 0) }}</p>
            <p>Total VMs: {{ vms|length }}</p>
            <p>Total Kubernetes Deployments: {{ kubernetes_deployments|length }}</p>
        </section>
        <section class="vm-list">
            <h2>Your Provisioned VMs</h2>
            {% if vms %}
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>CPU Cores</th>
                            <th>RAM (GB)</th>
                            <th>Disk Size (GB)</th>
                            <th>IP Address</th>
                            <th>OS Image</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for vm in vms %}
                        <tr>
                            <td>{{ vm.name }}</td>
                            <td>{{ vm.cpu_cores }}</td>
                            <td>{{ vm.ram }}</td>
                            <td>{{ vm.disk_size }}</td>
                            <td>{{ vm.ip_address }}</td>
                            <td>{{ vm.os_image }}</td>
                            <td>{{ vm.status|default('Running', true) }}</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <p>You haven't provisioned any VMs yet.</p>
            {% endif %}
        </section>
        <section class="kubernetes-list">
            <h2>Your Kubernetes Deployments</h2>
            {% if kubernetes_deployments %}
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Image</th>
                            <th>Replicas</th>
                            <th>Status</th>
                            <th>Created At</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for deployment in kubernetes_deployments %}
                        <tr>
                            <td>{{ deployment.name }}</td>
                            <td>{{ deployment.image }}</td>
                            <td>{{ deployment.replicas }}</td>
                            <td>{{ deployment.status }}</td>
                            <td>{{ deployment.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                            <td>
                                <form action="{{ url_for('auth.delete_kubernetes_deployment', deployment_id=deployment.id) }}" method="POST" style="display: inline;">
                                    <input type="submit" value="Delete" onclick="return confirm('Are you sure you want to delete this deployment?');">
                                </form>
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <p>You haven't created any Kubernetes deployments yet.</p>
            {% endif %}
        </section>
        <section class="provision-form">
            <h2>Provision a New VM</h2>
            <form method="POST" action="{{ url_for('auth.provision_vm') }}">
                {{ vm_form.hidden_tag() }}
                <div class="form-group">
                    {{ vm_form.name.label }}
                    {{ vm_form.name() }}
                </div>
                <div class="form-group">
                    {{ vm_form.cpu_cores.label }}
                    {{ vm_form.cpu_cores() }}
                </div>
                <div class="form-group">
                    {{ vm_form.ram.label }}
                    {{ vm_form.ram() }}
                </div>
                <div class="form-group">
                    {{ vm_form.disk_size.label }}
                    {{ vm_form.disk_size() }}
                </div>
                <div class="form-group">
                    {{ vm_form.os_image.label }}
                    {{ vm_form.os_image() }}
                </div>
                <div class="form-group">
                    {{ vm_form.submit() }}
                </div>
            </form>
        </section>
        <section class="kubernetes-form">
            <h2>Create a Kubernetes Deployment</h2>
            <form method="POST" action="{{ url_for('auth.create_kubernetes_deployment') }}">
                {{ kubernetes_form.hidden_tag() }}
                <div class="form-group">
                    {{ kubernetes_form.name.label }}
                    {{ kubernetes_form.name() }}
                </div>
                <div class="form-group">
                    {{ kubernetes_form.image.label }}
                    {{ kubernetes_form.image() }}
                </div>
                <div class="form-group">
                    {{ kubernetes_form.replicas.label }}
                    {{ kubernetes_form.replicas() }}
                </div>
                <div class="form-group">
                    {{ kubernetes_form.submit() }}
                </div>
            </form>
        </section>
        <section class="billing-form">
            <h2>Add Funds to Your Account</h2>
            <form method="POST" action="{{ url_for('auth.payment') }}">
                {{ billing_form.hidden_tag() }}
                <div class="form-group">
                    {{ billing_form.amount.label }}
                    {{ billing_form.amount() }}
                </div>
                <div class="form-group">
                    {{ billing_form.email.label }}
                    {{ billing_form.email() }}
                </div>
                <div class="form-group">
                    {{ billing_form.submit() }}
                </div>
            </form>
        </section>
    </div>
{% endblock %}

{% block extra_js %}
    <script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
{% endblock %}
